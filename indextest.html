<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMA Trend Dashboard ‚Äî Light / Dark (ECharts)</title>

  <!-- ECharts & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* keep all your same CSS here */
    /* ... unchanged CSS from your original ... */
  </style>
</head>
<body>
  <div class="container">
    <button id="themeToggle" class="theme-toggle">üåô Dark Mode</button>

    <div class="header">
      <h1>EMA Trend Dashboard</h1>
    </div>

    <div class="controls">
      <div class="timeframe-selector">
        <select id="timeframeSelect" aria-label="Select timeframe">
          <option value="trend_3m.csv">3 Minutes</option>
          <option value="trend_5m.csv">5 Minutes</option>
          <option value="trend_15m.csv">15 Minutes</option>
          <option value="trend_30m.csv">30 Minutes</option>
          <option value="trend_1h.csv">1 Hour</option>
          <option value="trend_4h.csv">4 Hours</option>
          <option value="trend_1d.csv">1 Day</option>
        </select>
      </div>

      <div class="status-indicator" title="Auto refresh interval">
        <div class="status-dot" aria-hidden="true"></div>
        <div>Auto-refresh: 1 min</div>
      </div>
    </div>

    <div class="chart-container">
      <div id="emaTrendChart" style="width:100%;height:100%;"></div>
    </div>

    <div class="chart-info" role="region" aria-label="Chart summary">
      <div class="info-card">
        <h3>Latest Value</h3>
        <div id="latestValue" class="value">--</div>
      </div>
      <div class="info-card">
        <h3>Data Points</h3>
        <div id="dataPoints" class="value">--</div>
      </div>
      <div class="info-card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="value">--</div>
      </div>
      <div class="info-card">
        <h3>Timeframe</h3>
        <div id="currentTimeframe" class="value">3 Minutes</div>
      </div>
    </div>

    <div id="errorMessage" aria-live="polite"></div>
    <div id="loadingMessage" class="loading" style="display:none">Loading data</div>
  </div>

  <script>
    // ---------- Config & state ----------
    let chart = null;
    let refreshInterval = null;
    const AUTO_REFRESH_MS = 60_000; // 1 minute
    const DEFAULT_CSV = 'trend_3m.csv';
    const TIME_LOCALE = 'nl-NL';

    const chartThemes = {
      light: {
        textColor: "#2c3e50",
        gridColor: "rgba(0,0,0,0.08)",
        bg: "#fff"
      },
      dark: {
        textColor: "#ecf0f1",
        gridColor: "rgba(255,255,255,0.12)",
        bg: "#1f2937"
      }
    };

    // ---------- Chart initialization ----------
    function initChart(theme = 'light') {
      const dom = document.getElementById('emaTrendChart');
      chart = echarts.init(dom, null, {renderer: 'canvas'});
      applyTheme(theme);
    }

    function updateChart(dataRows, theme) {
      const labels = dataRows.map(r => {
        const d = new Date(r.timestamp);
        if (isNaN(d)) return r.timestamp;
        return d.toLocaleTimeString(TIME_LOCALE, { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      });
      const values = dataRows.map(r => Number(r.trend_ema));

      const t = chartThemes[theme];

      const option = {
        backgroundColor: t.bg,
        tooltip: {
          trigger: 'axis'
        },
        grid: {
          left: 50, right: 20, top: 50, bottom: 50
        },
        xAxis: {
          type: 'category',
          data: labels,
          axisLabel: { color: t.textColor },
          axisLine: { lineStyle: { color: t.gridColor } }
        },
        yAxis: {
          type: 'value',
          axisLabel: { color: t.textColor },
          axisLine: { lineStyle: { color: t.gridColor } },
          splitLine: {
            lineStyle: { color: t.gridColor }
          }
        },
        series: [{
          name: 'EMA Trend',
          type: 'line',
          data: values,
          smooth: true,
          showSymbol: false,
          lineStyle: {
            width: 2,
            color: {
              type: 'linear',
              x: 0, y: 0, x2: 0, y2: 1,
              colorStops: [
                { offset: 0, color: '#2ecc71' }, // green above
                { offset: 0.48, color: '#f1c40f' }, // yellow near zero
                { offset: 1, color: '#e74c3c' }  // red below
              ]
            }
          },
          areaStyle: {
            opacity: 0.3,
            color: {
              type: 'linear',
              x: 0, y: 0, x2: 0, y2: 1,
              colorStops: [
                { offset: 0, color: 'rgba(46,204,113,0.4)' },
                { offset: 0.48, color: 'rgba(241,196,15,0.4)' },
                { offset: 1, color: 'rgba(231,76,60,0.4)' }
              ]
            }
          }
        }]
      };

      chart.setOption(option, true);
    }

    // ---------- Data loading (CSV) ----------
    async function loadData(filename) {
      const loadingEl = document.getElementById('loadingMessage');
      const errorEl = document.getElementById('errorMessage');
      loadingEl.style.display = 'block';
      errorEl.innerHTML = '';

      try {
        const resp = await fetch(`data/${filename}`, {cache: "no-store"});
        if (!resp.ok) throw new Error(`HTTP ${resp.status} - missing data/${filename}`);

        const csvText = await resp.text();
        const parseResult = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          delimitersToGuess: [',',';','\t','|']
        });

        const rows = (parseResult.data || []).filter(r =>
          r.timestamp && r.trend_ema !== undefined && r.trend_ema !== null && r.trend_ema !== '' && !isNaN(Number(r.trend_ema))
        );
        if (!rows.length) throw new Error("No valid data");

        rows.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

        const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
        updateChart(rows, currentTheme);
        updateInfo(rows, filename);

      } catch (err) {
        errorEl.innerHTML = `<div class="error-message">Error loading ${filename}: ${err.message}</div>`;
        console.error(err);
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    function updateInfo(dataRows, filename) {
      const latest = dataRows[dataRows.length - 1];
      const latestVal = latest ? Number(latest.trend_ema) : 0;
      const timeframeMap = {
        'trend_3m.csv': '3 Minutes',
        'trend_5m.csv': '5 Minutes',
        'trend_15m.csv': '15 Minutes',
        'trend_30m.csv': '30 Minutes',
        'trend_1h.csv': '1 Hour',
        'trend_4h.csv': '4 Hours',
        'trend_1d.csv': '1 Day'
      };

      document.getElementById('latestValue').textContent = (isNaN(latestVal) ? '--' : latestVal.toFixed(6));
      document.getElementById('dataPoints').textContent = dataRows.length;
      document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString(TIME_LOCALE, { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      document.getElementById('currentTimeframe').textContent = timeframeMap[filename] || filename;
    }

    // ---------- Auto-refresh ----------
    function setupAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(() => {
        const selected = document.getElementById('timeframeSelect').value;
        loadData(selected);
      }, AUTO_REFRESH_MS);
    }

    // ---------- Theme handling ----------
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
      themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
    }

    themeToggle.addEventListener('click', function() {
      const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
      // reload chart with new theme colors
      const selected = document.getElementById('timeframeSelect').value;
      loadData(selected);
    });

    // ---------- Init ----------
    window.addEventListener('load', function(){
      const savedTheme = localStorage.getItem('theme') || 'light';
      const savedTimeframe = localStorage.getItem('selectedTimeframe') || DEFAULT_CSV;

      const tfSelect = document.getElementById('timeframeSelect');
      for (let i=0;i<tfSelect.options.length;i++){
        if (tfSelect.options[i].value === savedTimeframe) { tfSelect.selectedIndex = i; break; }
      }

      initChart(savedTheme);
      applyTheme(savedTheme);
      loadData(savedTimeframe);
      setupAutoRefresh();
    });
  </script>
</body>
</html>
