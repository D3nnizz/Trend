<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMA Trend Dashboard — Light / Dark</title>

  <!-- Chart.js & PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      /* Light theme */
      --bg-gradient: linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
      --container-bg: rgba(255,255,255,0.95);
      --text-color: #2c3e50;
      --card-bg: #fff;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --border: #e0e6ed;
      --accent: #3498db;
      --accent-hover: #2980b9;
      --status-bg: rgba(46,204,113,0.08);
      --status-border: rgba(46,204,113,0.25);
      --status-color: #27ae60;
      --error-bg: rgba(231,76,60,0.08);
      --error-border: rgba(231,76,60,0.25);
      --error-color: #c0392b;
      --transition: 0.25s ease;
    }

    body.dark{
      /* Dark theme */
      --bg-gradient: linear-gradient(135deg,#12121a 0%,#243042 100%);
      --container-bg: rgba(28,32,44,0.92);
      --text-color: #ecf0f1;
      --card-bg: #1f2937;
      --shadow: 0 10px 30px rgba(0,0,0,0.6);
      --border: #3b4252;
      --accent: #9b59b6;
      --accent-hover: #8e44ad;
      --status-bg: rgba(46,204,113,0.12);
      --status-border: rgba(46,204,113,0.35);
      --status-color: #2ecc71;
      --error-bg: rgba(231,76,60,0.12);
      --error-border: rgba(231,76,60,0.35);
      --error-color: #e74c3c;
      --transition: 0.25s ease;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      padding:20px;
      min-height:100vh;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color:var(--text-color);
      background:var(--bg-gradient);
      transition: background var(--transition), color var(--transition);
    }

    .container{
      max-width:1400px;
      margin:0 auto;
      background:var(--container-bg);
      border-radius:14px;
      padding:28px;
      box-shadow:var(--shadow);
      transition: background var(--transition), box-shadow var(--transition);
      position:relative;
    }

    .header{ text-align:center; margin-bottom:20px; }
    .header h1{ margin:0; font-weight:300; font-size:2.25rem; letter-spacing:-0.5px }

    .theme-toggle{
      position:absolute;
      top:20px;
      right:24px;
      background:var(--accent);
      color:#fff;
      border:0;
      padding:8px 14px;
      border-radius:20px;
      cursor:pointer;
      font-size:14px;
      transition:background var(--transition), transform 0.12s;
    }
    .theme-toggle:hover{ background:var(--accent-hover); transform:translateY(-1px); }

    .controls{
      display:flex;
      justify-content:center;
      gap:18px;
      align-items:center;
      margin:18px 0 26px;
      flex-wrap:wrap;
    }

    .timeframe-selector select{
      padding:11px 18px;
      border-radius:10px;
      border:2px solid var(--border);
      background:var(--card-bg);
      color:var(--text-color);
      font-weight:600;
      cursor:pointer;
      appearance:none;
      transition:box-shadow var(--transition), border-color var(--transition);
    }
    .timeframe-selector select:hover{
      border-color:var(--accent);
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }

    .status-indicator{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 14px;
      border-radius:20px;
      background:var(--status-bg);
      border:1px solid var(--status-border);
      color:var(--status-color);
      font-weight:600;
      font-size:14px;
    }
    .status-dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background:var(--status-color);
      animation:pulse 2s infinite;
    }
    @keyframes pulse{ 0%{opacity:1} 50%{opacity:.45} 100%{opacity:1} }

    .chart-container{
      height:520px;
      background:var(--card-bg);
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
      transition:background var(--transition), box-shadow var(--transition);
    }

    .chart-info{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
      margin-top:18px;
    }

    .info-card{
      background:var(--card-bg);
      padding:18px;
      border-radius:10px;
      box-shadow:var(--shadow);
      text-align:center;
      transition: transform 0.12s var(--transition), box-shadow var(--transition);
      border:1px solid transparent;
    }
    .info-card:hover{ transform:translateY(-6px); box-shadow:0 14px 36px rgba(0,0,0,0.12); border-color:var(--border) }

    .info-card h3{ margin:0 0 10px; font-size:13px; text-transform:uppercase; letter-spacing:1px; color:var(--text-color); opacity:.85 }
    .info-card .value{ font-size:20px; font-weight:700; color:var(--text-color) }

    .error-message{
      margin-top:18px;
      border-radius:8px;
      padding:12px 14px;
      background:var(--error-bg);
      border:1px solid var(--error-border);
      color:var(--error-color);
      text-align:center;
    }

    .loading{
      text-align:center;
      padding:30px;
      color:var(--text-color);
    }

    /* small responsive */
    @media (max-width:700px){
      .header h1{font-size:1.5rem}
      .chart-container{height:420px}
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="themeToggle" class="theme-toggle">🌙 Dark Mode</button>

    <div class="header">
      <h1>EMA Trend Dashboard</h1>
    </div>

    <div class="controls">
      <div class="timeframe-selector">
        <select id="timeframeSelect" aria-label="Select timeframe">
          <option value="trend_3m.csv">3 Minutes</option>
          <option value="trend_5m.csv">5 Minutes</option>
          <option value="trend_15m.csv">15 Minutes</option>
          <option value="trend_30m.csv">30 Minutes</option>
          <option value="trend_1h.csv">1 Hour</option>
          <option value="trend_4h.csv">4 Hours</option>
          <option value="trend_1d.csv">1 Day</option>
        </select>
      </div>

      <div class="status-indicator" title="Auto refresh interval">
        <div class="status-dot" aria-hidden="true"></div>
        <div>Auto-refresh: 1 min</div>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="emaTrendChart" aria-label="EMA trend chart"></canvas>
    </div>

    <div class="chart-info" role="region" aria-label="Chart summary">
      <div class="info-card">
        <h3>Latest Value</h3>
        <div id="latestValue" class="value">--</div>
      </div>

      <div class="info-card">
        <h3>Data Points</h3>
        <div id="dataPoints" class="value">--</div>
      </div>

      <div class="info-card">
        <h3>Last Updated</h3>
        <div id="lastUpdated" class="value">--</div>
      </div>

      <div class="info-card">
        <h3>Timeframe</h3>
        <div id="currentTimeframe" class="value">3 Minutes</div>
      </div>
    </div>

    <div id="errorMessage" aria-live="polite"></div>
    <div id="loadingMessage" class="loading" style="display:none">Loading data</div>
  </div>

  <script>
    // ---------- Config & state ----------
    let chart = null;
    let refreshInterval = null;
    const AUTO_REFRESH_MS = 60_000; // 1 minute
    const DEFAULT_CSV = 'trend_3m.csv';
    const TIME_LOCALE = 'nl-NL'; // Europe/Amsterdam locale for formatting

    const chartThemes = {
      light: {
        borderColor: "#3498db",
        backgroundColor: "rgba(52,152,219,0.10)",
        gridColor: "rgba(0,0,0,0.08)",
        fontColor: "#2c3e50",
        tooltipBg: "rgba(0,0,0,0.8)",
        tooltipTitle: "#ffffff",
        tooltipBody: "#ffffff",
        zeroLineColor: "#e74c3c"
      },
      dark: {
        borderColor: "#9b59b6",
        backgroundColor: "rgba(155,89,182,0.12)",
        gridColor: "rgba(255,255,255,0.08)",
        fontColor: "#ecf0f1",
        tooltipBg: "rgba(255,255,255,0.92)",
        tooltipTitle: "#000000",
        tooltipBody: "#000000",
        zeroLineColor: "#e74c3c"
      }
    };

    // ---------- Chart initialization ----------
    function initChart(theme = 'light') {
      const ctx = document.getElementById('emaTrendChart').getContext('2d');
      const t = chartThemes[theme];

      if (chart) {
        try { chart.destroy(); } catch (e) {}
        chart = null;
      }

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'EMA Trend',
            data: [],
            borderWidth: 2,
            fill: false,
            tension: 0.35,
            pointRadius: 0,
            pointHoverRadius: 5,
            borderColor: function(context) {
              const chartArea = context.chart.chartArea;
              if (!chartArea) return t.borderColor;

              const { top, bottom } = chartArea;
              const gradient = ctx.createLinearGradient(0, bottom, 0, top);

              // Gradient: red (low) → yellow (zero) → green (high)
              gradient.addColorStop(0, 'red');
              gradient.addColorStop(0.5, 'yellow');
              gradient.addColorStop(1, 'green');

              return gradient;
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: t.fontColor,
                usePointStyle: true,
                padding: 16,
                font: { size: 13 }
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: t.tooltipBg,
              titleColor: t.tooltipTitle,
              bodyColor: t.tooltipBody,
              mode: 'index',
              intersect: false
            }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false },
          scales: {
            x: {
              ticks: { color: t.fontColor },
              grid: { color: t.gridColor },
              title: {
                display: true,
                text: 'Time',
                color: t.fontColor,
                font: { weight: '600' }
              }
            },
            y: {
              ticks: { color: t.fontColor },
              grid: {
                color: ctx => ctx.tick.value === 0 ? t.zeroLineColor : t.gridColor,
                lineWidth: ctx => ctx.tick.value === 0 ? 2 : 1
              },
              title: {
                display: true,
                text: 'EMA Trend',
                color: t.fontColor,
                font: { weight: '600' }
              },
              beginAtZero: false,
              afterDataLimits: function(scale) {
                const maxAbs = Math.max(Math.abs(scale.max), Math.abs(scale.min));
                scale.max = maxAbs;
                scale.min = -maxAbs;
              }
            }
          }
        }
      });
    }


    function updateChartTheme(theme) {
      if (!chart) return;
      const t = chartThemes[theme];

      // dataset style
      const ds = chart.data.datasets[0];
      ds.borderColor = t.borderColor;
      ds.backgroundColor = t.backgroundColor;
      ds.pointBackgroundColor = t.borderColor;
      ds.pointBorderColor = t.borderColor;

      // legend & tooltip
      chart.options.plugins.legend.labels.color = t.fontColor;
      chart.options.plugins.tooltip.backgroundColor = t.tooltipBg;
      chart.options.plugins.tooltip.titleColor = t.tooltipTitle;
      chart.options.plugins.tooltip.bodyColor = t.tooltipBody;

      // axes
      chart.options.scales.x.ticks.color = t.fontColor;
      chart.options.scales.x.grid.color = t.gridColor;
      chart.options.scales.x.title.color = t.fontColor;

      chart.options.scales.y.ticks.color = t.fontColor;
      chart.options.scales.y.title.color = t.fontColor;
      chart.options.scales.y.grid.color = function(context) {
        if (context.tick && context.tick.value === 0) return t.zeroLineColor;
        return t.gridColor;
      };
      chart.options.scales.y.grid.lineWidth = function(context) {
        if (context.tick && context.tick.value === 0) return 2;
        return 1;
      };

      chart.update();
    }

    // ---------- Data loading (CSV) ----------
    async function loadData(filename) {
      const loadingEl = document.getElementById('loadingMessage');
      const errorEl = document.getElementById('errorMessage');
      loadingEl.style.display = 'block';
      errorEl.innerHTML = '';

      try {
        const resp = await fetch(`data/${filename}`, {cache: "no-store"});
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status} - Make sure "data/${filename}" exists`);
        }
        const csvText = await resp.text();

        const parseResult = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          delimitersToGuess: [',',';','\t','|']
        });

        if (parseResult.errors && parseResult.errors.length) {
          // ignore harmless empty-row errors, but show if serious
          const serious = parseResult.errors.filter(e => e.code !== "TooFewFields");
          if (serious.length) {
            throw new Error('CSV parsing error: ' + serious.map(e => e.message).join('; '));
          }
        }

        // filter rows that have timestamp and numeric trend_ema
        const rows = (parseResult.data || []).filter(r => {
          return r.timestamp && r.trend_ema !== undefined && r.trend_ema !== null && r.trend_ema !== '' && !isNaN(Number(r.trend_ema));
        });

        if (!rows.length) {
          throw new Error('No valid data: ensure CSV includes `timestamp` and `trend_ema` columns with valid values.');
        }

        // sort ascending by timestamp
        rows.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

        // update chart & info
        updateChart(rows);
        updateInfo(rows, filename);

      } catch (err) {
        document.getElementById('errorMessage').innerHTML = `<div class="error-message">Error loading ${filename}: ${err.message}</div>`;
        console.error(err);
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    function updateChart(dataRows) {
      const labels = dataRows.map(r => {
        const d = new Date(r.timestamp);
        if (isNaN(d)) return r.timestamp; // fallback
        return d.toLocaleTimeString(TIME_LOCALE, { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      });
      const values = dataRows.map(r => Number(r.trend_ema) );

      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      chart.update('none');
    }

    function updateInfo(dataRows, filename) {
      const latest = dataRows[dataRows.length - 1];
      const latestVal = latest ? Number(latest.trend_ema) : 0;
      const timeframeMap = {
        'trend_3m.csv': '3 Minutes',
        'trend_5m.csv': '5 Minutes',
        'trend_15m.csv': '15 Minutes',
        'trend_30m.csv': '30 Minutes',
        'trend_1h.csv': '1 Hour',
        'trend_4h.csv': '4 Hours',
        'trend_1d.csv': '1 Day'
      };

      document.getElementById('latestValue').textContent = (isNaN(latestVal) ? '--' : latestVal.toFixed(6));
      document.getElementById('dataPoints').textContent = dataRows.length;
      document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString(TIME_LOCALE, { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      document.getElementById('currentTimeframe').textContent = timeframeMap[filename] || filename;
    }

    // ---------- Auto-refresh ----------
    function setupAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
      refreshInterval = setInterval(() => {
        const selected = document.getElementById('timeframeSelect').value;
        loadData(selected);
      }, AUTO_REFRESH_MS);
    }

    // ---------- Theme handling ----------
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
      // toggle button text
      themeToggle.textContent = theme === 'dark' ? '☀️ Light Mode' : '🌙 Dark Mode';
      // update Chart colors
      updateChartTheme(theme);
    }

    // ---------- Event listeners & initialization ----------
    document.getElementById('timeframeSelect').addEventListener('change', function() {
      const filename = this.value;
      localStorage.setItem('selectedTimeframe', filename);
      loadData(filename);
    });

    themeToggle.addEventListener('click', function() {
      const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
    });

    window.addEventListener('beforeunload', function() {
      if (refreshInterval) clearInterval(refreshInterval);
    });

    // on load:
    window.addEventListener('load', function(){
      // restore saved timeframe & theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      const savedTimeframe = localStorage.getItem('selectedTimeframe') || DEFAULT_CSV;

      // set timeframe select to saved value if present
      const tfSelect = document.getElementById('timeframeSelect');
      for (let i=0;i<tfSelect.options.length;i++){
        if (tfSelect.options[i].value === savedTimeframe) { tfSelect.selectedIndex = i; break; }
      }

      // init chart and theme
      initChart(savedTheme);
      applyTheme(savedTheme);

      // load data and start auto-refresh
      loadData(savedTimeframe);
      setupAutoRefresh();
    });
  </script>
</body>
</html>
